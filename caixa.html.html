<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>EasyComanda - Caixa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem;
        }
        .app-title {
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #0dcaf0; /* Cor para Caixa */
            font-size: 2.2rem;
            text-align: center;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .container-main {
            background-color: #1f1f1f;
            border-radius: 16px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            padding: 2rem;
            width: 100%;
            max-width: 700px;
            margin-bottom: 1.5rem;
        }
        .card-comanda {
            background-color: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 12px;
            margin-bottom: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .card-comanda:hover {
            background-color: #333333;
            transform: translateY(-3px);
        }
        .card-comanda.selected {
            border-color: #0dcaf0;
            box-shadow: 0 0 10px rgba(13, 202, 240, 0.5);
            background-color: #3a3a3a;
        }
        .card-comanda h5 {
            color: #f8f9fa;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .card-comanda p {
            color: #ccc;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        .badge-status {
            font-size: 0.85em;
            padding: 0.4em 0.8em;
            border-radius: 0.5rem;
            font-weight: 700;
        }
        .badge-aberta {
            background-color: #ffc107;
            color: #212529;
        }
        .badge-finalizada {
            background-color: #0dcaf0;
            color: #212529;
        }
        .badge-paga {
            background-color: #198754;
            color: #fff;
        }

        /* Detalhes da Comanda */
        #detalhesComandaSection {
            background-color: #2a2a2a;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: none; /* Escondido por padrão */
        }
        #detalhesComandaSection h4 {
            color: #0dcaf0;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        #detalhesComandaSection p {
            margin-bottom: 0.5rem;
            color: #e0e0e0;
        }
        #detalhesComandaSection .list-group-item {
            background-color: #333333;
            border: 1px solid #444;
            color: #e0e0e0;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            padding: 0.75rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #detalhesComandaSection .total-detail {
            font-size: 1.6rem;
            font-weight: 700;
            color: #ffc107;
            text-align: right;
            margin-top: 1rem;
        }

        /* Opções de Pagamento */
        .payment-options {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #3a3a3a;
        }
        .payment-options h5 {
            color: #e0e0e0;
            margin-bottom: 1rem;
        }
        .payment-method-btn {
            background-color: #444444;
            border: 1px solid #555555;
            color: #e0e0e0;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .payment-method-btn:hover {
            background-color: #555555;
            border-color: #666666;
            color: #fff;
        }
        .payment-method-btn.active {
            background-color: #0dcaf0;
            border-color: #0dcaf0;
            color: #212529;
            box-shadow: 0 0 10px rgba(13, 202, 240, 0.4);
        }

        /* Entrada de Valor Pago e Troco */
        #cashPaymentDetails {
            margin-top: 1rem;
            background-color: #333333;
            border-radius: 8px;
            padding: 1rem;
            display: none; /* Escondido por padrão */
        }
        #cashPaymentDetails label {
            color: #e0e0e0;
        }
        #trocoDisplay {
            font-size: 1.2rem;
            font-weight: 700;
            color: #198754;
            margin-top: 0.5rem;
        }

        /* Botões de Ação Final */
        .action-buttons {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        .action-buttons .btn {
            font-size: 1.1rem;
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            min-width: 150px;
        }
        .btn-confirm-payment {
            background-color: #198754;
            border-color: #198754;
            color: #fff;
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.4);
        }
        .btn-confirm-payment:hover {
            background-color: #146c43;
            border-color: #146c43;
            box-shadow: 0 6px 20px rgba(20, 108, 67, 0.6);
        }
        .btn-cancel-payment {
            background-color: #6c757d;
            border-color: #6c757d;
            color: #fff;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }
        .btn-cancel-payment:hover {
            background-color: #565e64;
            border-color: #565e64;
            box-shadow: 0 6px 20px rgba(86, 94, 100, 0.6);
        }
        .btn-back-main {
            background-color: #444;
            border-color: #444;
            color: white;
        }
        .btn-back-main:hover {
            background-color: #555;
            border-color: #555;
            color: white;
        }
        /* Estilo para o campo de filtro */
        #clienteFilter {
            background-color: #2f2f2f;
            border: 1px solid #444;
            color: #eee;
            border-radius: 12px;
            transition: border-color 0.3s ease;
        }
        #clienteFilter:focus {
            border-color: #0dcaf0;
            box-shadow: 0 0 8px #0dcaf088;
            background-color: #3b3b3b;
            color: #fff;
        }
        #totalConsolidadoDisplay {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffc107;
            text-align: center;
            margin-top: 1rem;
            padding: 1rem;
            background-color: #333;
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <script>
        // Validação de login
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        if (!usuarioLogado) {
            alert('Você precisa estar logado para acessar esta página.');
            window.location.href = 'login.html';
        }
    </script>

    <h2 class="app-title">EasyComanda - Caixa</h2>

    <div class="container-main">
        <h4 class="mb-4 text-center">Comandas a Pagar / Finalizar</h4>

        <div class="mb-3">
            <label for="clienteFilter" class="form-label">Filtrar por Cliente:</label>
            <select id="clienteFilter" class="form-select">
                <option value="">Mostrar Todas as Comandas</option>
                </select>
        </div>

        <div id="totalConsolidadoDisplay" style="display: none;">
            Total Pendente para o Cliente: R$ <span id="valorTotalConsolidado">0.00</span>
        </div>

        <div id="comandasList" class="mt-4">
            <p class="text-center text-muted">Nenhuma comanda encontrada.</p>
        </div>
    </div>

    <div class="container-main" id="detalhesComandaSection">
        <h4 id="detalheComandaTitulo">Detalhes da Comanda #ID</h4>
        <p><strong>Cliente:</strong> <span id="detalheClienteNome"></span></p>
        <p><strong>Garçom:</strong> <span id="detalheGarcomNome"></span></p>
        <p><strong>Data do Pedido:</strong> <span id="detalheData"></span></p>

        <h5 class="mt-4">Itens:</h5>
        <div id="detalhesItensList" class="list-group">
            </div>

        <div class="total-detail">
            Total da Comanda: R$ <span id="detalheTotalComanda">0.00</span>
        </div>

        <div class="payment-options">
            <h5 class="mb-3">Selecione a Forma de Pagamento:</h5>
            <div class="d-grid gap-2 d-md-flex justify-content-center mb-3">
                <button type="button" class="btn btn-outline-info payment-method-btn" data-method="pix">PIX</button>
                <button type="button" class="btn btn-outline-info payment-method-btn" data-method="debito">Cartão de Débito</button>
                <button type="button" class="btn btn-outline-info payment-method-btn" data-method="credito">Cartão de Crédito</button>
                <button type="button" class="btn btn-outline-info payment-method-btn" data-method="dinheiro">Dinheiro</button>
            </div>

            <div id="cashPaymentDetails">
                <div class="mb-3">
                    <label for="valorPagoInput" class="form-label">Valor Pago (Dinheiro):</label>
                    <input type="number" class="form-control" id="valorPagoInput" min="0" step="0.01" placeholder="Ex: 50.00" />
                </div>
                <div id="trocoDisplay" class="text-end">Troco: R$ 0.00</div>
            </div>
        </div>

        <div class="action-buttons">
            <button type="button" class="btn btn-confirm-payment" id="btnConfirmarPagamento" disabled>Confirmar Pagamento</button>
            <button type="button" class="btn btn-cancel-payment" id="btnCancelarDetalhes">Cancelar</button>
        </div>
    </div>

    <a href="index.html" class="btn btn-back-main w-100 mt-4" role="button" style="max-width: 400px;">Voltar ao Início</a>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const comandasListDiv = document.getElementById('comandasList');
            const detalhesComandaSection = document.getElementById('detalhesComandaSection');
            const detalheComandaTitulo = document.getElementById('detalheComandaTitulo');
            const detalheClienteNome = document.getElementById('detalheClienteNome');
            const detalheGarcomNome = document.getElementById('detalheGarcomNome');
            const detalheData = document.getElementById('detalheData');
            const detalhesItensList = document.getElementById('detalhesItensList');
            const detalheTotalComanda = document.getElementById('detalheTotalComanda');
            const paymentMethodButtons = document.querySelectorAll('.payment-method-btn');
            const cashPaymentDetails = document.getElementById('cashPaymentDetails');
            const valorPagoInput = document.getElementById('valorPagoInput');
            const trocoDisplay = document.getElementById('trocoDisplay');
            const btnConfirmarPagamento = document.getElementById('btnConfirmarPagamento');
            const btnCancelarDetalhes = document.getElementById('btnCancelarDetalhes');
            const clienteFilter = document.getElementById('clienteFilter'); // Novo elemento
            const totalConsolidadoDisplay = document.getElementById('totalConsolidadoDisplay'); // Novo elemento
            const valorTotalConsolidado = document.getElementById('valorTotalConsolidado'); // Novo elemento


            let currentSelectedComanda = null;
            let selectedPaymentMethod = null;

            // --- Funções Auxiliares para LocalStorage ---
            function getItems(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error(`Erro ao ler ${key} do localStorage:`, e);
                    return [];
                }
            }

            function saveItems(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error(`Erro ao salvar ${key} no localStorage:`, e);
                }
            }

            // --- Preencher filtro de clientes ---
            function populateClienteFilter() {
                const clientes = getItems('clientes');
                clienteFilter.innerHTML = '<option value="">Mostrar Todas as Comandas</option>';
                clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nome;
                    clienteFilter.appendChild(option);
                });
            }

            // --- Renderização das Comandas ---
            function renderComandas() {
                comandasListDiv.innerHTML = '';
                const comandas = getItems('comandas');
                const clientes = getItems('clientes');
                const garcons = getItems('garcons');

                const clienteIdFiltrado = clienteFilter.value;
                let totalConsolidado = 0;
                let comandasExibidas = [];

                if (clienteIdFiltrado) {
                    // Filtrar comandas pelo cliente selecionado
                    comandasExibidas = comandas.filter(c => 
                        (c.status === 'Aberta' || c.status === 'Finalizada') && 
                        c.clienteId === clienteIdFiltrado
                    );
                    // Calcular total consolidado
                    totalConsolidado = comandasExibidas.reduce((sum, comanda) => sum + comanda.total, 0);
                    valorTotalConsolidado.textContent = totalConsolidado.toFixed(2).replace('.', ',');
                    totalConsolidadoDisplay.style.display = 'block';
                } else {
                    // Mostrar todas as comandas pendentes
                    comandasExibidas = comandas.filter(c => c.status === 'Aberta' || c.status === 'Finalizada');
                    totalConsolidadoDisplay.style.display = 'none'; // Esconde o total consolidado se não houver filtro
                }

                if (comandasExibidas.length === 0) {
                    comandasListDiv.innerHTML = '<p class="text-center text-muted">Nenhuma comanda pendente de pagamento encontrada.</p>';
                    return;
                }

                comandasExibidas.forEach(comanda => {
                    const cliente = clientes.find(c => c.id === comanda.clienteId);
                    const garcom = garcons.find(g => g.id === comanda.garcomId);

                    const clienteNome = cliente ? cliente.nome : (comanda.clienteNome || 'Cliente Desconhecido');
                    const garcomNome = garcom ? garcom.nome : (comanda.garcomNome || 'Garçom Desconhecido');

                    const card = document.createElement('div');
                    card.classList.add('card-comanda');
                    card.dataset.comandaId = comanda.id;
                    card.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>Comanda #${comanda.id}</h5>
                            <span class="badge ${comanda.status === 'Aberta' ? 'badge-aberta' : 'badge-finalizada'} badge-status">
                                ${comanda.status === 'Aberta' ? 'Aberta' : 'Finalizada'} R$ ${comanda.total.toFixed(2).replace('.', ',')}
                            </span>
                        </div>
                        <p>Cliente: ${clienteNome}</p>
                        <p>Garçom: ${garcomNome}</p>
                        <p>Data: ${comanda.data}</p>
                    `;
                    card.addEventListener('click', () => showComandaDetails(comanda.id));
                    comandasListDiv.appendChild(card);
                });
            }

            // --- Exibir Detalhes da Comanda Selecionada ---
            function showComandaDetails(comandaId) {
                const comandas = getItems('comandas');
                currentSelectedComanda = comandas.find(c => c.id === comandaId);

                if (currentSelectedComanda) {
                    // Remover seleção de outros cards
                    document.querySelectorAll('.card-comanda').forEach(card => card.classList.remove('selected'));
                    // Adicionar seleção ao card clicado
                    document.querySelector(`.card-comanda[data-comanda-id="${comandaId}"]`).classList.add('selected');


                    const clientes = getItems('clientes');
                    const garcons = getItems('garcons');
                    
                    const cliente = clientes.find(c => c.id === currentSelectedComanda.clienteId);
                    const garcom = garcons.find(g => g.id === currentSelectedComanda.garcomId);

                    detalheComandaTitulo.textContent = `Detalhes da Comanda #${currentSelectedComanda.id}`;
                    detalheClienteNome.textContent = cliente ? cliente.nome : (currentSelectedComanda.clienteNome || 'Cliente Desconhecido');
                    detalheGarcomNome.textContent = garcom ? garcom.nome : (currentSelectedComanda.garcomNome || 'Garçom Desconhecido');
                    detalheData.textContent = currentSelectedComanda.data;
                    detalheTotalComanda.textContent = currentSelectedComanda.total.toFixed(2).replace('.', ',');

                    renderDetalhesItens(currentSelectedComanda.itens);
                    
                    detalhesComandaSection.style.display = 'block'; // Exibe a seção de detalhes
                    resetPaymentForm(); // Reseta os campos de pagamento
                }
            }

            // --- Renderizar Itens Detalhados e Unificar ---
            function renderDetalhesItens(itensComanda) {
                detalhesItensList.innerHTML = '';
                if (!itensComanda || itensComanda.length === 0) {
                    detalhesItensList.innerHTML = '<p class="text-center text-muted">Nenhum item nesta comanda.</p>';
                    return;
                }

                // Unificar itens duplicados (caso haja)
                const itensUnificados = {};
                itensComanda.forEach(item => {
                    if (itensUnificados[item.id]) {
                        itensUnificados[item.id].quantidade += item.quantidade;
                    } else {
                        itensUnificados[item.id] = { ...item };
                    }
                });

                for (const itemId in itensUnificados) {
                    const item = itensUnificados[itemId];
                    const listItem = document.createElement('div');
                    listItem.classList.add('list-group-item');
                    listItem.innerHTML = `
                        <span>${item.quantidade}x ${item.nome}</span>
                        <span>R$ ${(item.quantidade * item.preco).toFixed(2).replace('.', ',')}</span>
                    `;
                    detalhesItensList.appendChild(listItem);
                }
            }

            // --- Lógica de Pagamento ---
            function resetPaymentForm() {
                paymentMethodButtons.forEach(btn => btn.classList.remove('active'));
                cashPaymentDetails.style.display = 'none';
                valorPagoInput.value = '';
                trocoDisplay.textContent = 'Troco: R$ 0.00';
                selectedPaymentMethod = null;
                btnConfirmarPagamento.disabled = true; // Desabilita o botão até selecionar método
            }

            paymentMethodButtons.forEach(button => {
                button.addEventListener('click', () => {
                    paymentMethodButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    selectedPaymentMethod = button.dataset.method;
                    btnConfirmarPagamento.disabled = false; // Habilita o botão ao selecionar método

                    if (selectedPaymentMethod === 'dinheiro') {
                        cashPaymentDetails.style.display = 'block';
                        valorPagoInput.focus();
                        // Força a validação inicial do valor pago para troco
                        const total = currentSelectedComanda.total;
                        const valorPago = parseFloat(valorPagoInput.value.replace(',', '.')) || 0;
                        if (valorPago < total) {
                            btnConfirmarPagamento.disabled = true;
                        }
                    } else {
                        cashPaymentDetails.style.display = 'none';
                        valorPagoInput.value = '';
                        trocoDisplay.textContent = 'Troco: R$ 0.00';
                    }
                });
            });

            valorPagoInput.addEventListener('input', () => {
                const total = currentSelectedComanda.total;
                const valorPago = parseFloat(valorPagoInput.value.replace(',', '.')) || 0;
                const troco = valorPago - total;
                trocoDisplay.textContent = `Troco: R$ ${Math.max(0, troco).toFixed(2).replace('.', ',')}`;

                if (selectedPaymentMethod === 'dinheiro' && valorPago < total) {
                    btnConfirmarPagamento.disabled = true;
                } else if (selectedPaymentMethod) { // Garante que se houver um método selecionado, o botão é habilitado
                    btnConfirmarPagamento.disabled = false;
                }
            });


            btnConfirmarPagamento.addEventListener('click', () => {
                if (!currentSelectedComanda) {
                    alert('Nenhuma comanda selecionada.');
                    return;
                }
                if (!selectedPaymentMethod) {
                    alert('Selecione uma forma de pagamento.');
                    return;
                }

                if (selectedPaymentMethod === 'dinheiro') {
                    const total = currentSelectedComanda.total;
                    const valorPago = parseFloat(valorPagoInput.value.replace(',', '.')) || 0;
                    if (valorPago < total) {
                        alert('O valor pago é insuficiente para cobrir o total da comanda.');
                        return;
                    }
                }

                // Lógica para marcar a comanda como "Paga"
                let comandas = getItems('comandas');
                const comandaIndex = comandas.findIndex(c => c.id === currentSelectedComanda.id);

                if (comandaIndex > -1) {
                    comandas[comandaIndex].status = 'Paga';
                    comandas[comandaIndex].metodoPagamento = selectedPaymentMethod;
                    if (selectedPaymentMethod === 'dinheiro') {
                         comandas[comandaIndex].valorPago = parseFloat(valorPagoInput.value.replace(',', '.')) || 0;
                         comandas[comandaIndex].troco = Math.max(0, (comandas[comandaIndex].valorPago - comandas[comandaIndex].total));
                    }
                    saveItems('comandas', comandas);
                    alert(`Comanda #${currentSelectedComanda.id} paga com sucesso via ${selectedPaymentMethod}!`);
                    
                    // Esconde os detalhes e renderiza a lista atualizada
                    detalhesComandaSection.style.display = 'none';
                    currentSelectedComanda = null;
                    selectedPaymentMethod = null;
                    renderComandas(); // Renderiza com o filtro atual
                    populateClienteFilter(); // Repopula o filtro caso alguma comanda tenha sido removida
                    // Se o filtro de cliente estiver ativo, re-renderiza o total consolidado
                    if (clienteFilter.value) {
                         const filteredComandas = getItems('comandas').filter(c => 
                            (c.status === 'Aberta' || c.status === 'Finalizada') && 
                            c.clienteId === clienteFilter.value
                        );
                        const newTotalConsolidado = filteredComandas.reduce((sum, comanda) => sum + comanda.total, 0);
                        valorTotalConsolidado.textContent = newTotalConsolidado.toFixed(2).replace('.', ',');
                    }
                } else {
                    alert('Erro: Comanda não encontrada para atualização.');
                }
            });

            btnCancelarDetalhes.addEventListener('click', () => {
                detalhesComandaSection.style.display = 'none';
                document.querySelectorAll('.card-comanda').forEach(card => card.classList.remove('selected'));
                currentSelectedComanda = null;
                resetPaymentForm();
            });

            // --- Event Listener para o filtro de cliente ---
            clienteFilter.addEventListener('change', () => {
                detalhesComandaSection.style.display = 'none'; // Esconde detalhes ao mudar o filtro
                renderComandas(); // Renderiza as comandas filtradas
            });


            // --- Inicialização ---
            populateClienteFilter();
            renderComandas();
        });
    </script>
</body>
</html>
