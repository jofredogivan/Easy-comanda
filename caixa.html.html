<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>EasyComanda - Caixa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        .app-title {
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #6f42c1; /* Cor do Caixa */
            font-size: 2rem;
            text-align: center;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .container-main {
            background-color: #1f1f1f;
            border-radius: 16px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            padding: 2rem;
            width: 100%;
            max-width: 800px;
            margin-bottom: 1rem;
        }
        .list-group-item {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #333;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s ease, transform 0.2s ease;
            cursor: pointer;
        }
        .list-group-item:hover {
            background-color: #3a3a3a;
            transform: translateY(-2px);
        }
        .list-group-item.active {
            background-color: #6f42c1;
            border-color: #6f42c1;
            color: #fff;
        }
        .list-group-item .badge {
            font-size: 0.9em;
            padding: 0.4em 0.7em;
        }
        .detail-card {
            background-color: #2a2a2a;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #333;
            margin-top: 1.5rem;
        }
        .detail-card h5 {
            color: #6f42c1;
            margin-bottom: 1rem;
        }
        .detail-card .list-group-item {
            background-color: #333;
            border-color: #444;
        }
        .detail-card .list-group-item span:first-child {
            font-weight: 600;
        }
        .btn-custom {
            background-color: #6f42c1;
            border-color: #6f42c1;
            color: white;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .btn-custom:hover {
            background-color: #5a2e9d;
            border-color: #5a2e9d;
            color: white;
        }
        .btn-back {
            background-color: #444;
            border-color: #444;
            color: white;
        }
        .btn-back:hover {
            background-color: #555;
            border-color: #555;
            color: white;
        }
    </style>
</head>
<body>

    <h2 class="app-title">EasyComanda - Caixa</h2>

    <div class="container-main">
        <h4 class="mb-3 text-center">Comandas a Pagar / Finalizar</h4>
        <div id="comandasList" class="list-group mb-4">
            <p class="text-center text-muted mt-3" id="noComandasMessage">Nenhuma comanda para processar no momento.</p>
        </div>

        <div id="comandaDetails" class="detail-card d-none">
            <h5 class="mb-3">Detalhes da Comanda <span id="detailComandaId"></span></h5>
            <p><strong>Cliente:</strong> <span id="detailCliente"></span></p>
            <p><strong>Garçom:</strong> <span id="detailGarcom"></span></p>
            <p><strong>Data do Pedido:</strong> <span id="detailData"></span></p>
            <h6>Itens:</h6>
            <ul id="detailItems" class="list-group mb-3">
                </ul>
            <h5 class="text-end">Total: R$ <span id="detailTotal">0.00</span></h5>
            <p class="text-center text-muted mt-3" id="noDetailItemsMessage" style="display: none;">Nenhum item nesta comanda.</p>

            <div class="d-grid gap-2">
                <button class="btn btn-lg btn-success" id="btnMarcarPaga">Marcar como Paga</button>
                <button class="btn btn-lg btn-warning text-dark" id="btnFinalizarAqui" style="display: none;">Finalizar Comanda Aqui</button>                 <button class="btn btn-lg btn-secondary" id="btnVoltarLista">Voltar para a Lista</button>
            </div>
        </div>

        <div class="d-grid mt-4">
            <button class="btn btn-back btn-lg" onclick="window.location.href='index.html'">Voltar ao Início</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));
            if (!usuario || (usuario.perfil !== 'administrador' && usuario.perfil !== 'caixa')) {
                alert('Você não tem permissão para acessar esta página.');
                window.location.href = 'login.html';
                return;
            }

            const comandasList = document.getElementById('comandasList');
            const noComandasMessage = document.getElementById('noComandasMessage');
            const comandaDetails = document.getElementById('comandaDetails');
            const detailComandaId = document.getElementById('detailComandaId');
            const detailCliente = document.getElementById('detailCliente');
            const detailGarcom = document.getElementById('detailGarcom');
            const detailData = document.getElementById('detailData');
            const detailItems = document.getElementById('detailItems');
            const noDetailItemsMessage = document.getElementById('noDetailItemsMessage');
            const detailTotal = document.getElementById('detailTotal');
            const btnMarcarPaga = document.getElementById('btnMarcarPaga');
            const btnFinalizarAqui = document.getElementById('btnFinalizarAqui'); // Novo botão
            const btnVoltarLista = document.getElementById('btnVoltarLista');

            let currentComanda = null; // Alterado para armazenar o objeto completo da comanda

            function loadComandas() {
                const comandas = JSON.parse(localStorage.getItem('comandas')) || [];
                // ALTERAÇÃO AQUI: Mostrar todas as comandas que não estão pagas
                const comandasParaProcessar = comandas.filter(c => c.status !== 'Paga');

                comandasList.innerHTML = ''; // Limpa a lista existente
                if (comandasParaProcessar.length === 0) {
                    noComandasMessage.classList.remove('d-none');
                } else {
                    noComandasMessage.classList.add('d-none');
                    comandasParaProcessar.forEach(comanda => {
                        const listItem = document.createElement('a');
                        listItem.href = '#';
                        listItem.classList.add('list-group-item', 'list-group-item-action', 'd-flex', 'justify-content-between', 'align-items-center');
                        listItem.setAttribute('data-id', comanda.id);

                        const totalFormatted = (comanda.total || 0).toFixed(2).replace('.', ','); // Garante que total existe
                        const statusBadgeClass = comanda.status === 'Finalizada' ? 'bg-primary' : 'bg-warning text-dark';
                        const statusText = comanda.status === 'Finalizada' ? 'Finalizada' : 'Aberta';

                        listItem.innerHTML = `
                            <div>
                                Comanda #${comanda.id} - Cliente: ${comanda.clienteNome || 'N/A'}
                                <br>
                                <small class="text-muted">Garçom: ${comanda.garcomNome || 'N/A'} - Data: ${comanda.data || 'N/A'}</small>
                            </div>
                            <span class="badge ${statusBadgeClass} rounded-pill">${statusText} R$ ${totalFormatted}</span>
                        `;
                        listItem.addEventListener('click', (e) => {
                            e.preventDefault();
                            displayComandaDetails(comanda.id);
                        });
                        comandasList.appendChild(listItem);
                    });
                }
                comandaDetails.classList.add('d-none'); // Esconde os detalhes ao recarregar a lista
            }

            function displayComandaDetails(id) {
                const comandas = JSON.parse(localStorage.getItem('comandas')) || [];
                // Alterado para buscar qualquer comanda que não esteja paga
                const comanda = comandas.find(c => c.id === id && c.status !== 'Paga');

                if (comanda) {
                    currentComanda = comanda; // Armazena o objeto da comanda completo
                    detailComandaId.textContent = `#${comanda.id}`;
                    // Usando || 'Não Informado' para garantir que algo seja exibido
                    detailCliente.textContent = comanda.clienteNome || 'Não Informado';
                    detailGarcom.textContent = comanda.garcomNome || 'Não Informado';
                    detailData.textContent = comanda.data || 'Não Informada'; // Adicionado fallback

                    detailTotal.textContent = (comanda.total || 0).toFixed(2).replace('.', ',');

                    detailItems.innerHTML = '';
                    if (comanda.itens && comanda.itens.length > 0) {
                        noDetailItemsMessage.style.display = 'none';
                        comanda.itens.forEach(item => {
                            const listItem = document.createElement('li');
                            listItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                            listItem.innerHTML = `
                                <span>${item.quantidade}x ${item.nome}</span>
                                <span>R$ ${(item.quantidade * item.preco).toFixed(2).replace('.', ',')}</span>
                            `;
                            detailItems.appendChild(listItem);
                        });
                    } else {
                        noDetailItemsMessage.style.display = 'block';
                    }

                    comandasList.classList.add('d-none');
                    noComandasMessage.classList.add('d-none');
                    comandaDetails.classList.remove('d-none');

                    // Lógica para mostrar/esconder o botão "Finalizar Comanda Aqui"
                    if (comanda.status === 'Aberta') {
                        btnFinalizarAqui.style.display = 'block';
                        btnMarcarPaga.style.display = 'none'; // Esconde pagar se ainda não finalizada
                    } else {
                        btnFinalizarAqui.style.display = 'none';
                        btnMarcarPaga.style.display = 'block';
                    }

                    // Remove 'active' de todos e adiciona ao clicado
                    document.querySelectorAll('.list-group-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    document.querySelector(`.list-group-item[data-id="${id}"]`).classList.add('active');

                } else {
                    alert('Comanda não encontrada ou já está paga.');
                    loadComandas(); // Recarrega a lista caso a comanda não exista mais
                }
            }

            btnMarcarPaga.addEventListener('click', () => {
                if (currentComanda) {
                    // Se a comanda ainda não está finalizada, alerta
                    if (currentComanda.status === 'Aberta') {
                        alert('Esta comanda ainda está aberta. Por favor, finalize-a primeiro.');
                        return;
                    }

                    let comandas = JSON.parse(localStorage.getItem('comandas')) || [];
                    const index = comandas.findIndex(c => c.id === currentComanda.id);

                    if (index !== -1) {
                        comandas[index].status = 'Paga';
                        comandas[index].dataPagamento = new Date().toLocaleString();
                        localStorage.setItem('comandas', JSON.stringify(comandas));
                        alert(`Comanda #${currentComanda.id} marcada como Paga!`);
                        loadComandas();
                        comandaDetails.classList.add('d-none');
                    }
                }
            });

            // NOVO EVENT LISTENER para Finalizar Comanda no Caixa
            btnFinalizarAqui.addEventListener('click', () => {
                if (currentComanda && currentComanda.status === 'Aberta') {
                    if (confirm('Tem certeza que deseja FINALIZAR esta comanda? Ela poderá ser paga em seguida.')) {
                        let comandas = JSON.parse(localStorage.getItem('comandas')) || [];
                        const index = comandas.findIndex(c => c.id === currentComanda.id);

                        if (index !== -1) {
                            comandasList[index].status = 'Finalizada'; // Atualiza o status
                            // Garante que a data e total estão corretos
                            comandasList[index].data = comandasList[index].data || new Date().toLocaleString();
                            comandasList[index].total = comandasList[index].itens.reduce((sum, item) => sum + (item.quantidade * item.preco), 0);
                            
                            localStorage.setItem('comandas', JSON.stringify(comandasList));
                            alert(`Comanda #${currentComanda.id} finalizada com sucesso!`);
                            loadComandas(); // Recarrega a lista
                            displayComandaDetails(currentComanda.id); // Re-exibe detalhes (agora como finalizada)
                        }
                    }
                }
            });

            btnVoltarLista.addEventListener('click', () => {
                comandaDetails.classList.add('d-none');
                comandasList.classList.remove('d-none');
                loadComandas(); // Garante que a lista esteja atualizada
            });

            // Carrega as comandas ao iniciar a página
            loadComandas();
        });
    </script>
</body>
</html>
