<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>EasyComanda - Caixa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        .app-title {
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #6f42c1; /* Cor do Caixa */
            font-size: 2rem;
            text-align: center;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .container-main {
            background-color: #1f1f1f;
            border-radius: 16px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            padding: 2rem;
            width: 100%;
            max-width: 800px;
            margin-bottom: 1rem;
        }
        .list-group-item {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #333;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s ease, transform 0.2s ease;
            cursor: pointer;
        }
        .list-group-item:hover {
            background-color: #3a3a3a;
            transform: translateY(-2px);
        }
        .list-group-item.active {
            background-color: #6f42c1;
            border-color: #6f42c1;
            color: #fff;
        }
        .list-group-item .badge {
            font-size: 0.9em;
            padding: 0.4em 0.7em;
        }
        .detail-card {
            background-color: #2a2a2a;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #333;
            margin-top: 1.5rem;
        }
        .detail-card h5 {
            color: #6f42c1;
            margin-bottom: 1rem;
        }
        .detail-card .list-group-item {
            background-color: #333;
            border-color: #444;
        }
        .detail-card .list-group-item span:first-child {
            font-weight: 600;
        }
        .btn-custom {
            background-color: #6f42c1;
            border-color: #6f42c1;
            color: white;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .btn-custom:hover {
            background-color: #5a2e9d;
            border-color: #5a2e9d;
            color: white;
        }
        .btn-back {
            background-color: #444;
            border-color: #444;
            color: white;
        }
        .btn-back:hover {
            background-color: #555;
            border-color: #555;
            color: white;
        }
    </style>
</head>
<body>

    <h2 class="app-title">EasyComanda - Caixa</h2>

    <div class="container-main">
        <h4 class="mb-3 text-center">Comandas a Pagar</h4>
        <div id="comandasList" class="list-group mb-4">
            <p class="text-center text-muted mt-3" id="noComandasMessage">Nenhuma comanda finalizada no momento.</p>
        </div>

        <div id="comandaDetails" class="detail-card d-none">
            <h5 class="mb-3">Detalhes da Comanda <span id="detailComandaId"></span></h5>
            <p><strong>Cliente:</strong> <span id="detailCliente"></span></p>
            <p><strong>Garçom:</strong> <span id="detailGarcom"></span></p>
            <p><strong>Data:</strong> <span id="detailData"></span></p>
            <h6>Itens:</h6>
            <ul id="detailItems" class="list-group mb-3">
                </ul>
            <h5 class="text-end">Total: R$ <span id="detailTotal">0.00</span></h5>
            <div class="d-grid gap-2">
                <button class="btn btn-lg btn-success" id="btnMarcarPaga">Marcar como Paga</button>
                <button class="btn btn-lg btn-secondary" id="btnVoltarLista">Voltar para a Lista</button>
            </div>
        </div>

        <div class="d-grid mt-4">
            <button class="btn btn-back btn-lg" onclick="window.location.href='index.html'">Voltar ao Início</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));
            if (!usuario || (usuario.perfil !== 'administrador' && usuario.perfil !== 'caixa')) { // Adicionei perfil 'caixa'
                alert('Você não tem permissão para acessar esta página.');
                window.location.href = 'login.html';
                return;
            }

            const comandasList = document.getElementById('comandasList');
            const noComandasMessage = document.getElementById('noComandasMessage');
            const comandaDetails = document.getElementById('comandaDetails');
            const detailComandaId = document.getElementById('detailComandaId');
            const detailCliente = document.getElementById('detailCliente');
            const detailGarcom = document.getElementById('detailGarcom');
            const detailData = document.getElementById('detailData');
            const detailItems = document.getElementById('detailItems');
            const detailTotal = document.getElementById('detailTotal');
            const btnMarcarPaga = document.getElementById('btnMarcarPaga');
            const btnVoltarLista = document.getElementById('btnVoltarLista');

            let currentComandaId = null;

            function loadComandas() {
                const comandas = JSON.parse(localStorage.getItem('comandas')) || [];
                const comandasFinalizadas = comandas.filter(c => c.status === 'Finalizada');

                comandasList.innerHTML = ''; // Limpa a lista existente
                if (comandasFinalizadas.length === 0) {
                    noComandasMessage.classList.remove('d-none');
                } else {
                    noComandasMessage.classList.add('d-none');
                    comandasFinalizadas.forEach(comanda => {
                        const listItem = document.createElement('a');
                        listItem.href = '#';
                        listItem.classList.add('list-group-item', 'list-group-item-action', 'd-flex', 'justify-content-between', 'align-items-center');
                        listItem.setAttribute('data-id', comanda.id);

                        const totalFormatted = comanda.total.toFixed(2).replace('.', ',');
                        listItem.innerHTML = `
                            <div>
                                Comanda #${comanda.id} - Cliente: ${comanda.clienteNome || 'N/A'}
                                <br>
                                <small class="text-muted">Garçom: ${comanda.garcomNome || 'N/A'} - Data: ${comanda.data}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">R$ ${totalFormatted}</span>
                        `;
                        listItem.addEventListener('click', (e) => {
                            e.preventDefault();
                            displayComandaDetails(comanda.id);
                        });
                        comandasList.appendChild(listItem);
                    });
                }
                comandaDetails.classList.add('d-none'); // Esconde os detalhes ao recarregar a lista
            }

            function displayComandaDetails(id) {
                const comandas = JSON.parse(localStorage.getItem('comandas')) || [];
                const comanda = comandas.find(c => c.id === id && c.status === 'Finalizada');

                if (comanda) {
                    currentComandaId = id;
                    detailComandaId.textContent = `#${comanda.id}`;
                    detailCliente.textContent = comanda.clienteNome || 'Não Informado';
                    detailGarcom.textContent = comanda.garcomNome || 'Não Informado';
                    detailData.textContent = comanda.data;
                    detailTotal.textContent = comanda.total.toFixed(2).replace('.', ',');

                    detailItems.innerHTML = '';
                    comanda.itens.forEach(item => {
                        const listItem = document.createElement('li');
                        listItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                        listItem.innerHTML = `
                            <span>${item.quantidade}x ${item.nome}</span>
                            <span>R$ ${(item.quantidade * item.preco).toFixed(2).replace('.', ',')}</span>
                        `;
                        detailItems.appendChild(listItem);
                    });

                    comandasList.classList.add('d-none');
                    noComandasMessage.classList.add('d-none');
                    comandaDetails.classList.remove('d-none');

                    // Remove 'active' de todos e adiciona ao clicado
                    document.querySelectorAll('.list-group-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    document.querySelector(`.list-group-item[data-id="${id}"]`).classList.add('active');

                } else {
                    alert('Comanda não encontrada ou não está finalizada.');
                    loadComandas(); // Recarrega a lista caso a comanda não exista mais
                }
            }

            btnMarcarPaga.addEventListener('click', () => {
                if (currentComandaId) {
                    let comandas = JSON.parse(localStorage.getItem('comandas')) || [];
                    const index = comandas.findIndex(c => c.id === currentComandaId);

                    if (index !== -1) {
                        comandas[index].status = 'Paga'; // Altera o status para 'Paga'
                        comandas[index].dataPagamento = new Date().toLocaleString(); // Registra data de pagamento
                        localStorage.setItem('comandas', JSON.stringify(comandas));
                        alert(`Comanda #${currentComandaId} marcada como Paga!`);
                        loadComandas(); // Recarrega a lista para remover a comanda paga
                        comandaDetails.classList.add('d-none'); // Esconde os detalhes
                    }
                }
            });

            btnVoltarLista.addEventListener('click', () => {
                comandaDetails.classList.add('d-none');
                comandasList.classList.remove('d-none');
                loadComandas(); // Garante que a lista esteja atualizada
            });

            // Carrega as comandas ao iniciar a página
            loadComandas();
        });
    </script>
</body>
</html>